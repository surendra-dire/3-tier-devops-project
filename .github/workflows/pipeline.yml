name: Deploy Node App to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Zip project
    - name: Create Deployment Package
      run: |
        zip -r app.zip . -x "*.git*"

    # Upload zip to EC2
    - name: Upload Zip to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "app.zip"
        target: "/home/ubuntu"

    # SSH into EC2 and deploy
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e

          echo "ğŸ“¦ Cleaning old deployment"
          rm -rf /home/ubuntu/app || true

          echo "ğŸ“‚ Unzipping new code"
          unzip -o /home/ubuntu/app.zip -d /home/ubuntu/app

          cd /home/ubuntu/app/api

          echo "ğŸ“¦ Installing Backend Dependencies"
          npm install

          echo "ğŸ” Running Backend Tests"
          npm test || echo "âš  No backend tests found"

          echo "ğŸ›¡ Running Security Scan"
          npm audit --audit-level=high || true

          echo "ğŸš€ Starting Backend (PM2)"
          npm start

          cd /home/ubuntu/app/frontend

          echo "ğŸ“¦ Installing Frontend Dependencies"
          npm install

          echo "ğŸ”§ Building Frontend"
          npm run build || echo "âš  No build script found"

          echo "ğŸš€ Starting Frontend"
          npm start

          echo "ğŸ‰ Deployment Complete"
