name: Deploy Node App to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Zip project
    - name: Create Deployment Package
      run: |
        zip -r app.zip . -x "*.git*"

    # Upload zip to EC2
    - name: Upload Zip to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "app.zip"
        target: "/home/ubuntu"
        overwrite: true

    # SSH into EC2 and deploy
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e

          echo "ğŸ“¦ Cleaning old deployment"
          rm -rf /home/ubuntu/app || true

          echo "ğŸ“‚ Unzipping new code"
          unzip -o /home/ubuntu/app.zip -d /home/ubuntu/app

          echo "ğŸ“¦ Backend Setup"
          cd /home/ubuntu/app/api
          npm install

          # echo "ğŸ” Running Backend Tests"
          # npm test || echo "âš  No backend tests found"

          echo "ğŸ›¡ Security Scan"
          npm audit --audit-level=high || true

          echo "ğŸš€ Starting Backend with PM2"
          pm2 restart backend || pm2 start app.js --name backend

          echo "ğŸ“¦ Frontend Setup"
          cd /home/ubuntu/app/client
          npm install

          echo "ğŸ” Running Backend Tests"
          npm test || echo "âš  No backend tests found"
          
          echo "ğŸ”§ Building Frontend"
          npm run build || echo "âš  No build script found"
          
          echo "ğŸš€ Starting Frontend with PM2"
          pm2 restart frontend || pm2 start "npm start" --name frontend

          echo "ğŸ’¾ Saving PM2 Processes"
          pm2 save

          echo "ğŸ‰ Deployment Complete"
