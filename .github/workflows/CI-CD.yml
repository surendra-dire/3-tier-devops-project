name: CI-CD-3-Tier-App

on:
  workflow_dispatch:
  #push:
    #branches: [ "main" ]
  #pull_request:
    #branches: [ "main" ]

jobs:

  # ----------------------------
  # BACKEND BUILD + SCAN
  # ----------------------------
  backend:
    name: Backend Pipeline
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # Install Node & dependencies
    - name: Install Backend Dependencies
      working-directory: ./api
      run: |
        npm install

    # Security scan
    - name: Run Security Scan
      working-directory: ./api
      run: |
        npm audit --audit-level=high || true

    # Build backend Docker image
    - name: Build Backend Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/user-manager-api:latest ./api

    # Login & Push image
    - name: Push Backend Image
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push ${{ secrets.DOCKER_USERNAME }}/user-manager-api:latest

  # ----------------------------
  # FRONTEND BUILD + SCAN + DEPLOY
  # ----------------------------
  frontend:
    name: Frontend Pipeline
    runs-on: ubuntu-latest
    needs: backend

    steps:
    - uses: actions/checkout@v3

    # Install dependencies
    - name: Install Frontend Dependencies
      working-directory: ./frontend
      run: |
        npm install

    # Run frontend build
    - name: Build Frontend
      working-directory: ./frontend
      run: |
        npm run build

    # Security scan
    - name: Run Frontend Security Scan
      working-directory: ./frontend
      run: |
        npm audit --audit-level=high || true

    # Build Docker image
    - name: Build Frontend Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/user-manager-frontend:latest ./frontend

    # Push Image
    - name: Push Frontend Image
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker push ${{ secrets.DOCKER_USERNAME }}/user-manager-frontend:latest

  # ----------------------------
  # 3️⃣ DEPLOY TO EC2 (SSH)
  # ----------------------------
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: frontend

    steps:
    - name: Deploying to EC2 via SSH
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/user-manager-api:latest
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/user-manager-frontend:latest

          # Stop running containers
          sudo docker stop api || true
          sudo docker stop frontend || true
          sudo docker rm api || true
          sudo docker rm frontend || true

          # Run backend container
          sudo docker run -d --name api \
            -p 5000:5000 \
            --env-file /home/ubuntu/api.env \
            ${{ secrets.DOCKER_USERNAME }}/user-manager-api:latest

          # Run frontend container
          sudo docker run -d --name frontend \
            -p 80:80 \
            ${{ secrets.DOCKER_USERNAME }}/user-manager-frontend:latest
